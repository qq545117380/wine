function addrMoney(){var t=$(".addr_list .active").data("id"),e=PayMoney();$.ajax({type:"POST",url:"http://order.gjw.com/Order_Api/GetYunFei",data:{sumProMoney:e,addrid:t,isbaoyou:$("#baoyou").val()},async:!1,datatype:"json",success:function(t){var e=t;if(1==e.Success){var o=e.Data;$("#lbFreight").html(o),PayMoney()}},error:function(t){alert(t.responseText)}})}function PayMoney(t){var e=moneyFormat($("#lbSumProMoney").html()),o=moneyFormat($("#lbFreight").html()),n=moneyFormat($("#lbVoucherMoney").html()),a=moneyFormat($("#lbAccount").html()),c=moneyFormat($("#LbScore").html()),r=moneyFormat($("#lbSumReductionMoney").html()),i=moneyFormat($("#lbOnlinePayReduceM").html()),l=0;return l=e+o-n-a-c-r-i,1==t?l=e+o-n-c-r-i:2==t&&(l=e+o-n-a-r-i),$("#SumMoney").html("¥"+fmoney(l.toFixed(2),2)),l}function moneyFormat(t){return parseFloat(t.replace(/[^\d\.-]/g,""))}function fmoney(e,o){o=o>0&&o<=20?o:2,e=parseFloat((e+"").replace(/[^\d\.-]/g,"")).toFixed(o)+"";var n=e.split(".")[0].split("").reverse(),a=e.split(".")[1];for(t="",i=0;i<n.length;i++)t+=n[i]+((i+1)%3==0&&i+1!=n.length?",":"");return t.split("").reverse().join("")+"."+a}function VoucherSet(t,e){$.ajax({type:"POST",url:vou,data:{VID:t,addrid:e},async:!1,datatype:"json",success:function(e){if(0==e.Success){var o=e.data;$("#lbVoucherMoney").html(o.money),$("#lbFreight").html(o.yunfei),addrMoney(),$(".dis").css("display","none"),$("#dis"+t).css("display","-webkit-inline-box")}else layer.msg(e.Message),$('#coupon input[type="radio"]:checked"').attr("checked",!1),$("#lbVoucherMoney").html(0)},error:function(t){alert(t.responseText)}})}$(function(){$("#addAddr").click(function(){ifrmReceiveAdd.Open(function(t){layer.msg("添加成功！"),window.location="http://order.gjw.com/order/settlement"})})}),$(function(){$("#fapiaoCheck").click(function(){$(this).is(":checked")?$("#faPiaoBox").show():$("#faPiaoBox").hide()}),$(".field").change(function(){1==$(this).val()?$(".shui").show():$(".shui").hide()})}),$(function(){var t="http://order.gjw.com/order/PostOrder";$("#btnOk").click(function(){var e=$(".addr_list .active").data("id"),o=$(".payList .active").text(),n=4,a=$('#coupon input[type="radio"]:checked"').val();"货到付款 "==o&&(n=1);var c="";return $("#fapiaoCheck").is(":checked")&&""==$("#txtInvoiceTitle").val()?(layer.msg("客官，请填写发票信息"),!1):$("#fapiaoCheck").is(":checked")&&1==$(".field").val()&&""==$("#txtshui").val()?(layer.msg("客官，请填写 税号信息"),!1):(c=$("#txtInvoiceTitle").val()+"; 税号："+$("#txtshui").val(),""==$("#txtInvoiceTitle").val()&&(c=""),void $.ajax({type:"POST",url:t,data:{AddrID:e,PayType:n,InvoiceTitle:c,VID:a,Jifen:$("#txtScore").val(),hongbao:$("#txtAccount").val(),toggle:$("#txtIntro").val(),SumMoney:moneyFormat($("#SumMoney").html())},async:!1,datatype:"JSONP",success:function(t){0==t.Success?window.location="http://order.gjw.com/order/Finish.html":layer.msg(t.Message)}}))})}),$(function(){$("#AOk").click(function(){$("#txtAccount").show(),$(this).hide(),$("#ARest").show()}),$("#txtAccount").keyup(function(){if(""==$(this).val())$("#lbAccount").html(0),$("#spOk").hide(),PayMoney();else{var t=(moneyFormat($("#lbFreight").html()),PayMoney(1));console.log(t);var e=moneyFormat($(this).val());e<=moneyFormat($("#spAccount").html())&&e<=t?e<=t?($("#lbAccount").html(e),$(this).val(e),$("#spOk").show(),PayMoney()):(layer.msg("客官，您此次余额抵扣最多能使用"+moneyFormat($("#spAccount").html())+"."),$("#lbAccount").html(moneyFormat($("#spAccount").html())),$(this).val(moneyFormat($("#spAccount").html())),$("#spOk").show(),PayMoney()):e<moneyFormat($("#spAccount").html())&&e>t||e>moneyFormat($("#spAccount").html())&&e>t&&moneyFormat($("#spAccount").html())>t?(layer.msg("客官，您此次余额抵扣使用"+t+"就可以了。"),$("#lbAccount").html(t),$(this).val(t),$("#spOk").show(),PayMoney()):(layer.msg("客官，您此次余额抵扣最多能使用"+moneyFormat($("#spAccount").html())),$("#lbAccount").html(moneyFormat($("#spAccount").html())),$(this).val(moneyFormat($("#spAccount").html())),$("#spOk").show(),PayMoney())}}),$("#ARest").click(function(){$("#txtAccount").val(""),$("#lbAccount").html(0),$("#spOk").hide(),$("#txtAccount").hide(),$("#AOk").show(),$(this).hide(),PayMoney()})}),$(function(){$("#AScore").click(function(){$("#txtScore").show(),$(this).hide(),$("#ARest2").show()}),$("#txtScore").keyup(function(){if(""==$(this).val())$("#LbScore").html(0),$("#Span2").hide(),PayMoney();else{if($("#txtScore").val().split(".").length>1)return layer.msg("客官，请使用整数倍的积分"),!1;var t=moneyFormat($("#lbFreight").html()),e=moneyFormat($("#lbAccount").html()),o=moneyFormat($("#lbSumProMoney").html()),n=moneyFormat($("#Span1").html()),a=moneyFormat($(this).val()),c=PayMoney(2);if(a>=moneyFormat($("#Span1").html()))a=moneyFormat($("#Span1").html()),n>=2e3?n=a=2e3:a=n,100*o>=n&&100*o>moneyFormat($(this).val())&&moneyFormat($(this).val())<n?a=n=o:e-t<0&&(o=n/100),0!=t&&(c=o+t-e,e-t<0&&(c=o),n=100*c,n>moneyFormat($("#Span1").html())&&(n=moneyFormat($("#Span1").html())),n>=100*o&&n>=2e3&&(n=100*moneyFormat($("#lbSumProMoney").html()))),n>2e3&&(n=2e3),layer.msg("客官，您此次消费积分最多能使用"+n+"。"),$("#LbScore").html(n/100),$(this).val(n),$("#Span2").show(),PayMoney();else{if(!(a<=2e3)){var c=PayMoney(2),r=$(this).val().substr(0,$(this).val().length-1);return r<=0&&(r=0),0!=t&&a<n&&(c=o+t-e,e-t<0&&(c+=e-t),r=100*c),r>2e3&&(r=2e3),layer.msg("客官，此订单不能抵扣"+$(this).val()+"积分哟，详情请咨询客服！"),$(this).val(r),$("#LbScore").html(r/100),$("#Span2").show(),PayMoney(),!1}var c=PayMoney(2);0!=t&&(c=o+t-e,e-t<0&&(c+=e-t),n=100*c);var n=moneyFormat($(this).val());100*c<n&&(n=100*c,n<=0&&(n=""),layer.msg("客官，此订单不能抵扣"+$(this).val()+"积分，详情请咨询客服！"),$(this).val(n)),$("#LbScore").html(n/100),$("#Span2").show(),PayMoney()}}}),$("#ARest2").click(function(){$("#txtScore").val(""),$("#LbScore").html(0),$("#Span2").hide(),$("#txtScore").hide(),$("#AScore").show(),$(this).hide(),PayMoney()})}),PayMoney();var vou="http://order.gjw.com/Order_Api/VoucherSet";$(".SetVouchers").click(function(){var t=$(this).attr("id"),e=moneyFormat($("#lbSumProMoney").html()),o=0;e-30<100&&(o=$(".addr_list .active").data("id")),VoucherSet(t,o)}),$(".dis").click(function(){$('#coupon input[type="radio"]:checked"').attr("checked",!1),$(".dis").css("display","none"),$("#lbVoucherMoney").html(0),addrMoney(),PayMoney()});